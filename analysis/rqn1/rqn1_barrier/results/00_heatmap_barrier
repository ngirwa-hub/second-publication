# ---- Packages ----
if (!requireNamespace("tidyverse", quietly = TRUE)) install.packages("tidyverse")
if (!requireNamespace("scales", quietly = TRUE)) install.packages("scales")
library(tidyverse)
library(scales)

# ---- Paths ----
in_path  <- "barrier_selection_rates.csv"
out_path <- "barrier_selection_heatmap.png"

# ---- Read data ----
df <- readr::read_csv(in_path, show_col_types = FALSE)

# ---- Label map for rows (units) ----
label_map <- c(
  "human"       = "DC experts",
  "LLM_overall" = "Pooled-LLM",
  "gemma3-12b"  = "Gemma3:12B",
  "llama-pro"   = "LlaMa-Pro",
  "mistral"     = "Mistral",
  "phi4"        = "Phi4"
)

# keep original row order from the file
unit_levels <- df$unit |> as.character()

# barrier columns (B1..B11)
#barrier_cols <- paste0("B", 1:11)
barrier_cols <- grep("^B\\d+$", colnames(df), value = TRUE)
barrier_cols <- barrier_cols[order(as.numeric((sub("B", "", barrier_cols))))]  # ensure sorted order

# ---- Long format + percent handling ----
plot_df <- df |>
  mutate(unit = factor(unit, levels = unit_levels)) |>
  mutate(unit_label = recode(as.character(unit), !!!label_map, .default = as.character(unit))) |>
  pivot_longer(all_of(barrier_cols), names_to = "barrier", values_to = "val_raw") |>
  mutate(barrier = factor(barrier, levels = barrier_cols))

# detect if values are proportions (0â€“1)
range_max <- max(plot_df$val_raw, na.rm = TRUE)

if (is.finite(range_max) && range_max <= 1 + 1e-9) {
  plot_df <- plot_df |> mutate(val = val_raw * 100)
} else {
  plot_df <- plot_df |> mutate(val = val_raw)
}

# ---- Plot ----
p <- ggplot(plot_df, aes(x = barrier, y = unit_label, fill = val)) +
  geom_tile(color = "white", linewidth = 0.3) +
  geom_text(aes(label = sprintf("%.0f%%", val)), size = 3, na.rm = TRUE) +
  scale_fill_gradient(
    low = "white", high = "steelblue",
    limits = c(0, 100),
    labels = function(x) sprintf("%.0f%%", x),
    na.value = "grey90",
    name = "Selection rate (%)"
  ) +
  labs(
    title = "Barrier Selection Rates - Zero-shot",
    x = "Barrier code",
    y = "Source"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid = element_blank(),
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5),
    axis.ticks = element_blank()
  )

# ---- Save ----
ggsave(out_path, p, width = 8, height = 4, dpi = 300)
p
